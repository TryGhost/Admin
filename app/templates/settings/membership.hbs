<section class="gh-canvas circle-bg" {{did-insert this.setup}}>
    <GhCanvasHeader class="gh-canvas-header gh-setting-members-header">
        <h2 class="gh-canvas-title" data-test-screen-title>
            <LinkTo @route="settings">{{t "Manual.Settings.Settings"}}</LinkTo>
            <span>{{svg-jar "arrow-right"}}</span>
            {{t "Manual.Settings.Membership"}}
        </h2>
        <section class="view-actions">
            <GhTaskButton
                @buttonText={{t "Manual.Settings.Save"}}
                @task={{this.saveSettingsTask}}
                @successText={{t "Manual.Settings.Saved"}}
                @runningText={{t "Manual.Settings.Saving"}}
                @class="gh-btn gh-btn-primary gh-btn-icon"
                data-test-button="save-settings"
            />
        </section>
    </GhCanvasHeader>

    <section class="view-container settings-debug">

        <div class="gh-main-layout content-preview">
            <div class="gh-setting-members-basicsform">
                <p class="intro">{{t "Manual.Others.Fund_your_work_with_subscription_revenue_Connect_your_Stripe_account_and_offer_premium_content_to_your_audience_Our_creators_are_already_making_over_5_million_per_year_while"}} <strong>{{t "Manual.Others.Ghost_takes_0_payment_fees"}}</strong>.</p>
                <hr>
                <div>
                    <section class="gh-expandable gh-setting-members-portalcta">
                        <div class="gh-expandable-block">
                            <div class="gh-expandable-header">
                                <div>
                                    <h4 class="gh-expandable-title">{{t "Manual.Settings.Portal_Settings"}}</h4>
                                    <p class="gh-expandable-description">
                                        {{t "Manual.Settings.Customize_members_modal_signup_flow"}}
                                    </p>
                                </div>
                                <button type="button" class="gh-btn gh-btn-green" disabled={{eq this.settings.membersSignupAccess "none"}} {{on "click" this.openPortalSettings}} data-test-toggle="portal-settings">
                                    <span>{{t "Manual.Settings.Customize_Portal"}}</span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <div class="gh-setting-members-access">
                        <Settings::MembersSubscriptionAccess @onChange={{this.membersSubscriptionAccessChanged}} />
                        <Settings::MembersDefaultPostAccess />
                    </div>
                </div>
            </div>
            <div class="gh-setting-members-portalpreview">
                <div class="gh-setting-members-portal-mock {{if (feature "multipleProducts") "mock-enabled"}}">
                    {{#if (or (eq this.settings.membersSignupAccess 'none') this.switchFromNoneTask.isRunning)}}
                        <div class="gh-setting-members-portal-disabled">
                            <span class="lightgrey">{{svg-jar "portal-logo-stroke"}}</span>
                            <h4>{{t "Manual.Settings.Portal_disable"}}</h4>
                            <p>{{t "Manual.Settings.Change_your_Subscription_Access_setting_to_re-enable_Portal"}}</p>
                        </div>
                    {{else}}
                        <GhSiteIframe
                            scrolling="no"
                            @src={{this.portalPreviewUrl}}
                            @invisibleUntilLoaded="portal-ready"
                            @onInserted={{this.portalPreviewInserted}}
                            @onDestroyed={{this.portalPreviewDestroyed}} />
                    {{/if}}
                </div>
            </div>
        </div>

        <div class="gh-setting-members-tierscontainer">
            <div class="gh-settings-members-tiersheader">
                <h4 class="gh-main-section-header small bn">{{t "Manual.Settings.MEMBERSHIP_TIERS"}}</h4>
                {{#if this.session.user.isAdmin}}
                <button type="button" class="gh-btn gh-btn-outline gh-btn-stripe-status {{if this.isConnectDisallowed "disabled"}} {{if this.settings.stripeConnectAccountId "connected" ""}}" {{on "click" this.openStripeConnect}}>
                    <span>
                        {{#if this.settings.stripeConnectAccountId}}
                            {{t "Manual.Settings.Connected_to_Stripe"}}
                        {{else}}
                            {{t "Manual.Settings.Stripe_not_connected"}}
                        {{/if}}
                    </span>
                </button>
                {{/if}}
            </div>
            <section class="gh-expandable">
                <div class="gh-expandable-block">
                    <div class="gh-expandable-header">
                        <div>
                            <h4 class="gh-expandable-title">{{t "Manual.Settings.Free"}}</h4>
                            <p class="gh-expandable-description">{{t "Manual.Settings.Free_member_sign_up_settings"}}</p>
                        </div>
                        <button type="button" class="gh-btn" {{on "click" (toggle "freeOpen" this)}} data-test-toggle-pub-info>
                            <span>
                                {{#if this.freeOpen}}
                                    {{t "Manual.Settings.Close"}}
                                {{else}}
                                    {{t "Manual.Settings.Expand"}}
                                {{/if}}
                            </span>
                        </button>
                    </div>
                    <div class="gh-expandable-content">
                        {{#liquid-if this.freeOpen}}
                        <div class="gh-setting-content-extended">
                            <GhFormGroup @errors={{this.settings.errors}} @hasValidated={{this.settings.hasValidated}} @property="free-welcome-page">
                                <label for="freeWelcomePage">{{t "Manual.Settings.Welcome_page"}}</label>
                                <GhUrlInput
                                    @id="freeWelcomePage"
                                    @value={{readonly this.settings.membersFreeSignupRedirect}}
                                    @baseUrl={{readonly this.siteUrl}}
                                    @setResult={{this.setFreeSignupRedirect}}
                                    @validateUrl={{this.validateFreeSignupRedirect}}
                                    @placeholder={{readonly this.siteUrl}}
                                />
                                <GhErrorMessage
                                    @errors={{settings.errors}}
                                    @property="membersFreeSignupRedirect"
                                />
                                <p>{{t "Manual.Settings.Redirect_to_this_URL_after_signup_for_a_free_membership"}}</p>
                            </GhFormGroup>
                        </div>
                        {{/liquid-if}}
                    </div>
                </div>
            </section>
            <section class="gh-expandable">
                <div class="gh-expandable-block">
                    <div class="gh-expandable-header">
                        <div>
                            <h4 class="gh-expandable-title">{{t "Manual.Settings.Premium"}}</h4>
                            <p class="gh-expandable-description">{{t "Manual.Settings.Set_prices_and_paid_member_sign_up_settings"}}</p>
                        </div>

                        {{#if this.settings.stripeConnectAccountId}}
                            <button type="button" class="gh-btn" {{on "click" (toggle "paidOpen" this)}} data-test-toggle-pub-info>
                                <span>
                                    {{#if this.paidOpen}}
                                        {{t "Manual.Settings.Close"}}
                                    {{else}}
                                        {{t "Manual.Settings.Expand"}}
                                    {{/if}}
                                </span>
                            </button>
                        {{else}}
                            <button type="button" class="stripe-connect {{if (or (not this.session.user.isAdmin) this.isConnectDisallowed) "disabled"}}" {{on "click" this.openStripeConnect}}>
                                <span>{{t "Manual.Settings.Connect_with_Stripe"}}</span>
                            </button>
                        {{/if}}
                    </div>
                    {{#if this.isConnectDisallowed}}
                    <div class="gh-setting-nossl">
                        <div class="gh-setting-nossl-container">
                            <span class="red">{{svg-jar "shield-lock"}}</span>
                            <h4>{{t "Manual.Settings.Your_site_is_not_secured"}}</h4>
                            <p>{{t "Manual.Settings.Paid_membership_through"}} <a href="https://ghost.org/integrations/lets-encrypt/" target="_blank" rel="noopener noreferrer">{{t "Manual.Settings.found_here"}}</a>.</p>
                        </div>
                    </div>
                    {{/if}}
                    <div class="gh-expandable-content">
                        {{#liquid-if this.paidOpen}}
                        <div class="gh-setting-content-extended">
                            {{#if this.fetchDefaultProduct.isRunning}}
                                {{t "Manual.Dashboard.Loading..."}}
                            {{else}}
                                {{#if (feature "multipleProducts")}}
                                    <GhMembershipProductsAlpha
                                        @products={{this.products}}
                                        @confirmProductSave={{this.confirmProductSave}}
                                    />
                                {{else}}
                                    <GhFormGroup @errors={{this.settings.errors}} @hasValidated={{this.settings.hasValidated}} @property="prices">
                                        <div class="gh-settings-members-pricelabelcont">
                                            <label for="monthlyPrice">{{t "Manual.Settings.Prices"}}</label>
                                            <span>–</span>
                                            <div>
                                                <span class="gh-setting-members-currency gh-select">
                                                    <div class="gh-setting-members-currencylabel">
                                                        <span>{{this.currency}}</span>
                                                        {{svg-jar "arrow-down-small"}}
                                                    </div>
                                                    <OneWaySelect
                                                        @value={{this.selectedCurrency}}
                                                        id="currency"
                                                        name="currency"
                                                        @options={{readonly this.allCurrencies}}
                                                        @optionValuePath="value"
                                                        @optionLabelPath="label"
                                                        @update={{this.setStripePlansCurrency}}
                                                    />
                                                </span>
                                            </div>
                                        </div>
                                        <div class="gh-setting-members-prices">

                                            <div class="gh-input-group">
                                                <GhTextInput
                                                    @id="monthlyPrice"
                                                    @value={{readonly this.stripeMonthlyAmount}}
                                                    @type="number"
                                                    @input={{action (mut this.stripeMonthlyAmount) value="target.value"}}
                                                    @focus-out={{action "validateStripePlans"}}
                                                />
                                                <span class="gh-input-append"><span class="ttu">{{this.currency}}</span>/month</span>
                                            </div>
                                            <div class="gh-input-group">
                                                <GhTextInput
                                                    @id="yearlyPrice"
                                                    @value={{readonly this.stripeYearlyAmount}}
                                                    @type="number"
                                                    @input={{action (mut this.stripeYearlyAmount) value="target.value"}}
                                                    @focus-out={{this.validateStripePlans}}
                                                    @placeholder=''
                                                    data-test-title-input={{true}}
                                                />
                                                <span class="gh-input-append"><span class="ttu">{{this.currency}}</span>/year</span>
                                            </div>
                                        </div>
                                        {{#if this.stripePlanError}}
                                            <p class="response w-100"><span class="red">{{this.stripePlanError}}</span></p>
                                        {{/if}}
                                    </GhFormGroup>

                                {{/if}}
                                <GhFormGroup @errors={{this.settings.errors}} @hasValidated={{this.settings.hasValidated}} @property="paid-welcome-page">
                                    <label for="paidWelcomePage">{{t "Manual.Settings.Welcome_page"}}</label>
                                    <GhUrlInput
                                        @value={{readonly this.settings.membersPaidSignupRedirect}}
                                        @baseUrl={{readonly this.siteUrl}}
                                        @setResult={{this.setPaidSignupRedirect}}
                                        @validateUrl={{this.validatePaidSignupRedirect}}
                                        @placeholder={{readonly this.siteUrl}}
                                    />
                                    <GhErrorMessage
                                        @errors={{settings.errors}}
                                        @property="membersPaidSignupRedirect"
                                    />
                                    <p>{{t "Manual.Settings.Redirect_to_this_URL_after_signup_for_a_free_membership"}}</p>
                                </GhFormGroup>
                            {{/if}}
                        </div>
                        {{/liquid-if}}
                    </div>
                </div>
            </section>
        </div>
    </section>

    {{#if this.showLeaveRouteModal}}
        <GhFullscreenModal
            @modal="leave-settings"
            @confirm={{this.confirmLeave}}
            @close={{this.cancelLeave}}
            @modifier="action wide"
        />
    {{/if}}

    {{#if this.showPortalSettings}}
        <GhFullscreenModal @modal="portal-settings"
            @model={{hash
                preloadTask=this.saveSettingsTask
                openStripeSettings=this.openStripeConnect
                products=this.products
            }}
            @close={{this.closePortalSettings}}
            @modifier="full-overlay portal-settings" />
    {{/if}}

    {{#if this.showLeavePortalModal}}
        <GhFullscreenModal
            @modal="leave-settings"
            @confirm={{this.confirmClosePortalSettings}}
            @close={{this.cancelClosePortalSettings}}
            @modifier="action wide"
        />
    {{/if}}

    {{#if this.showStripeConnect}}
        <GhFullscreenModal
            @modal="stripe-connect"
            @close={{this.closeStripeConnect}}
            @modifier="action wide stripe-connect" />
    {{/if}}
</section>
